<%= form_for @sale, :url => collect_quantity_path, :method => collect_quantity_method, :html => {id: "ticket_form", class: "ticket-form"} do |f| %>
  <% if @sale.errors.any? %>
    <div id="error_explanation">
      <ul>
      <% unless @sale.errors.include?(:purchases) %>
        <% @sale.errors.full_messages.each do |msg| %>
          <li style="color:red"><%= msg %></li>
        <% end %>
      <% end %>
      <% @sale.purchases.each do |purchase| %>
        <% purchase.errors.full_messages.each do |msg| %>
          <li style="color:red"><%= msg %></li>
        <% end %>
      <% end %>
      </ul>
    </div>
  <% end %>

  <h3>Tickets</h3>
  <div class='tickets'>
    <% @tickets.each do |current_ticket| %>
      <% [current_ticket.revisions.last].each do |revision| %>
        <%= f.fields_for revision do |ticket_fields| %>
          <% purchase = @sale.purchases.find_by(ticket_revision_id: revision.id) %>
          <% data = revision.ticket_data %>
          <div class="ticket">
            <div class="ticket-title">
              <div class="ticket-count">
                <div class='select-box'><%= select_tag "ticket[ticket_ids][#{revision.ticket_id}]", options_for_select((1..25).to_a) %></div>
                <button type='submit' class='add-to-cart'>Add</button>
              </div>
              <h4><%= data["name"] %></h4> <span class='ticket-price'><%= price(data["price"]) %></span>
            </div>
            <% if data["description"] %><p class="ticket-description"><%= data["description"] %></p><% end %>
          </div>
        <% end %>
      <% end %>
    <% end %>
  </div>

  <h3>Discount Packages</h3>
  <div class='tickets'>
    <% @packages.each do |current_package| %>
      <% [current_package.revisions.last].each do |revision| %>
        <%= f.fields_for revision do |package_fields| %>
          <% purchase = @sale.purchases.find_by(package_revision_id: revision.id) %>
          <% data = revision.package_data %>
          <div class="ticket">
            <div class="ticket-title">
              <div class="ticket-count">
                <div class='select-box'><%= select_tag "package[package_ids][#{revision.package_id}]", options_for_select((1..25).to_a) %></div>
                <button type='submit' class='add-to-cart'>Add</button>
              </div>
              <h4><%= data["name"] %></h4> <span class='ticket-price'><%= price(data["price"]) %></span>
            </div>
          
            <% if data["description"] %><p class="ticket-description"><%= data["description"] %></p><% end %>
          </div>
        <% end %>
      <% end %>
    <% end %>
  </div>

  <div>
  <div class='form-footer'>
    <%= f.hidden_field :token, value: @sale.token %>
    <button class='continue' type='submit'>Checkout &rarr;</button>
  </div>
</div>
<% end %>

<%= render 'quick_cart' %>
