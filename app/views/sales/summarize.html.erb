<% content_for :head do %>
  <script src="https://checkout.stripe.com/checkout.js"></script>
  <script type="text/javascript">
    // Handle Safari back/forward cache after checkout completed.
    $(window).bind("pageshow", function(event) {
      if (event.originalEvent.persisted) {
        window.location.reload()
      }
    });
  </script>
<% end %>

<div id='summary'>
  <% if @sale.email %>
    <h3 class='section-heading'>Purchase Summary</h3>
      <div class='card'>
  <% end %>

  <div class='personal-info-summary'><%= personal_info %></div>

  <% if @sale.email %>
    <%= render 'static_cart' %>
    </div>
    <%= render partial: "checkout_form", locals: { button_text: "Purchase" } %>
    <%= form_for @sale, :url => {action: "charge", redemption_code: @sale.redemption_code}, :method => "patch", :html => {:id => "payment_form"} do |f| %>
      <input type="hidden" name="sale[stripe_token]" id="stripe_token"/>
    <% end %>
    
    <script type="text/javascript">
      <% tp_quantity = @sale.purchases.where(type: 'TicketPurchase').inject(0) { |total, tp| total + tp.quantity } %>
      <% pp_quantity = @sale.purchases.where(type: 'PackagePurchase').inject(0) { |total, tp| total + tp.quantity } %>

      var handler = StripeCheckout.configure({
        key: 'pk_test_1E89hNXMZYx4QpJPN297vKur',
        token: function(token) {
          payment_form = $('#payment_form');
          payment_form.find('#stripe_token').val(token.id);
          payment_form.submit();
        }
      });

      $(".primary-button").on("click", function() {
        this.attr('disabled', 'disabled')
        handler.open({
          name: 'DeSoto Caverns',
          description: '<%= tp_quantity %> ticket<% if tp_quantity > 1 || tp_quantity == 0 %>s<% end %>, <%= pp_quantity %> package<% if pp_quantity > 1 || pp_quantity == 0 %>s<% end %>',
          email: "<%= @sale.email %>",
          amount: <%= @sale.charge_total %>,
          allowRememberMe: false
        });
      });

      $(window).on('popstate', function() {
        handler.close();
      });
    </script>
  <% end %>
</div>
