<% if @sale.errors.empty? %>
  $('#personal_info_form').html("<%= escape_javascript render(partial: 'personal_info') %>");
  $('#outer').append("<%= escape_javascript render(partial: 'collect_card', status: :success) %>");

  $( document ).ready( function() {
    var handler = StripeCheckout.configure({
      key: 'pk_test_lgoJadzJlZSpLwrY1sJPinZK',
      token: function(token) {
        payment_form = $('#payment_form');
        payment_form.find('#stripe_token').val(token.id);
        payment_form.submit()
      }
    });

    handler.open({
      name: 'DeSoto Caverns',
      description: '1 Ticket',
      email: "<%= @sale.email %>",
      amount: 100 <%# @purchase.js_calculated_price.to_int * 1.04 %>,
      allowRememberMe: false
    });
    e.preventDefault();

    $(window).on('popstate', function() {
      handler.close();
    });
  });
<% else %>
  $('#personal_info_errors').html("<%= escape_javascript render(partial: 'errors') %>");
  $('#accordion').accordion("refresh");
<% end %>
