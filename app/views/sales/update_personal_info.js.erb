<% if @sale.errors.empty? %>
  $(':root').append("<%= escape_javascript render(partial: 'collect_card', status: :success) %>");

  <% tp_quantity = @sale.purchases.where(type: 'TicketPurchase').inject(0) { |total, tp| total + tp.quantity } %>
  <% pp_quantity = @sale.purchases.where(type: 'PackagePurchase').inject(0) { |total, tp| total + tp.quantity } %>

  var handler = StripeCheckout.configure({
    key: 'pk_test_lgoJadzJlZSpLwrY1sJPinZK',
    token: function(token) {
      payment_form = $('#payment_form');
      payment_form.find('#stripe_token').val(token.id);
      payment_form.submit();
    }
  });

  handler.open({
    name: 'DeSoto Caverns',
    description: '<%= tp_quantity %> ticket<% if tp_quantity > 1 || tp_quantity == 0 %>s<% end %>, <%= pp_quantity %> package<% if pp_quantity > 1 || pp_quantity == 0 %>s<% end %>',
    email: "<%= @sale.email %>",
    amount: <%= @sale.charge_total %>,
    allowRememberMe: false
  });

  e.preventDefault();

  $(window).on('popstate', function() {
    handler.close();
  });
<% else %>
  $('#personal_info_errors').html("<%= escape_javascript render(partial: 'personal_info_errors') %>");
<% end %>
